<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.25s ease; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { border: 1px solid #e5e7eb; min-height: 120px; }
        .day-header { background-color: #f9fafb; }
        .metric-label { font-size: 0.7rem; color: #6b7280; }
        .metric-value { font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <!-- Login View -->
        <div id="loginView" class="max-w-md mx-auto bg-white rounded-xl shadow-md mt-10 p-8">
            <h1 class="text-2xl font-bold text-center text-gray-700 mb-6">Growth Tracker Login</h1>
            <div class="space-y-4">
                <select id="userSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Login</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="hidden">
            <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Welcome, <span id="staffName"></span></h1>
                    <p class="text-gray-500">Your daily performance dashboard.</p>
                </div>
                <div class="flex items-center space-x-2">
                     <button onclick="openModal('clockInModal')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">Clock In</button>
                     <button onclick="openModal('clockOutModal')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md">Clock Out</button>
                     <button onclick="openModal('logActivityModal')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Log Activity</button>
                     <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">Logout</button>
                </div>
            </header>

            <!-- Calendar Controls -->
            <div class="flex justify-between items-center bg-white p-4 rounded-t-lg shadow">
                <button onclick="changeMonth(-1)" class="px-3 py-1 bg-gray-200 rounded-md">&lt; Prev</button>
                <h2 id="monthYearHeader" class="text-xl font-bold"></h2>
                <button onclick="changeMonth(1)" class="px-3 py-1 bg-gray-200 rounded-md">Next &gt;</button>
            </div>

            <!-- Calendar -->
            <div id="calendarContainer" class="bg-white rounded-b-lg shadow overflow-hidden">
                <!-- Headers -->
                <div class="calendar-grid day-header font-bold text-center text-sm text-gray-600">
                    <div>Sunday</div> <div>Monday</div> <div>Tuesday</div> <div>Wednesday</div> <div>Thursday</div> <div>Friday</div> <div>Saturday</div>
                </div>
                <!-- Days -->
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modalBackdrop" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden"></div>

    <!-- Clock In Modal -->
    <div id="clockInModal" class="fixed inset-0 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Clock In: <span id="yesterdayDate"></span></h3>
            <p class="text-sm text-gray-500 mb-4">Enter your metric totals for the previous workday.</p>
            <div class="space-y-3">
                <input type="number" id="yesterdayDials" placeholder="Total Dials Yesterday" class="w-full p-2 border rounded-md">
                <input type="number" id="yesterdayPresentations" placeholder="Total Presentations Yesterday" class="w-full p-2 border rounded-md">
                <input type="number" id="yesterdayBinds" placeholder="Total Binds Yesterday" class="w-full p-2 border rounded-md">
                <input type="number" id="yesterdayAlp" placeholder="Total ALP Yesterday" class="w-full p-2 border rounded-md">
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button onclick="closeModal('clockInModal')" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
                <button onclick="submitClockIn()" class="px-4 py-2 bg-green-500 text-white rounded-md">Submit</button>
            </div>
        </div>
    </div>

    <!-- Clock Out Modal -->
     <div id="clockOutModal" class="fixed inset-0 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Clock Out: <span id="todayDate"></span></h3>
             <p class="text-sm text-gray-500 mb-4">Enter your metric totals for today.</p>
            <div class="space-y-3">
                <input type="number" id="todayDials" placeholder="Total Dials Today" class="w-full p-2 border rounded-md">
                <input type="number" id="todayPresentations" placeholder="Total Presentations Today" class="w-full p-2 border rounded-md">
                <input type="number" id="todayBinds" placeholder="Total Binds Today" class="w-full p-2 border rounded-md">
                <input type="number" id="todayAlp" placeholder="Total ALP Today" class="w-full p-2 border rounded-md">
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button onclick="closeModal('clockOutModal')" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
                <button onclick="submitClockOut()" class="px-4 py-2 bg-yellow-500 text-white rounded-md">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Log Activity Modal -->
     <div id="logActivityModal" class="fixed inset-0 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-4">Log an Activity</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <select id="activityType" class="w-full p-2 border rounded-md"><option>Presentation</option><option>Call</option><option>Sales</option></select>
                <select id="activityOutcome" class="w-full p-2 border rounded-md"><option>Policy Issued</option><option>Pending</option><option>No-Sale</option><option>Follow-up</option></select>
                <input type="text" id="activityCustomer" placeholder="Customer Name/Info" class="w-full p-2 border rounded-md md:col-span-2">
                <input type="number" id="activityAlp" placeholder="ALP (if applicable)" class="w-full p-2 border rounded-md">
                <textarea id="activityNotes" placeholder="Notes..." class="w-full p-2 border rounded-md md:col-span-2" rows="3"></textarea>
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button onclick="closeModal('logActivityModal')" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
                <button onclick="submitActivity()" class="px-4 py-2 bg-blue-500 text-white rounded-md">Log Activity</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2giojWF7vLmR-6qWkKBc_lM0VJWQVj5IR9_q6hx1wVb6OHCvl9zxPICEzwFHww7_1fA/exec'; // IMPORTANT: Paste your Google Apps Script URL here
        const STAFF_LIST = ["Alice", "Bob", "Charlie", "David"];

        let currentUser = null;
        let currentDate = new Date();

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!SCRIPT_URL) console.warn('SCRIPT_URL is not set.');
            const userSelect = document.getElementById('userSelect');
            STAFF_LIST.forEach(name => userSelect.innerHTML += `<option value="${name}">${name}</option>`);
        });

        // --- Auth & View Management ---
        function login() {
            const user = document.getElementById('userSelect').value;
            if (!user) return alert('Please select a name.');
            currentUser = user;
            document.getElementById('staffName').textContent = currentUser;
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            renderDashboard();
        }

        function logout() {
            currentUser = null;
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('loginView').classList.remove('hidden');
        }

        function openModal(modalId) {
            document.getElementById('modalBackdrop').classList.remove('hidden');
            document.getElementById(modalId).classList.remove('hidden');
            if (modalId === 'clockInModal') {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                document.getElementById('yesterdayDate').textContent = yesterday.toLocaleDateString();
            } else if (modalId === 'clockOutModal') {
                document.getElementById('todayDate').textContent = new Date().toLocaleDateString();
            }
        }

        function closeModal(modalId) {
            document.getElementById('modalBackdrop').classList.add('hidden');
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // --- Dashboard & Calendar ---
        async function renderDashboard() {
            if (!SCRIPT_URL) {
                return alert("SCRIPT_URL is not configured. Please paste your Google Apps Script URL into the SCRIPT_URL constant in the HTML file.");
            }
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            document.getElementById('monthYearHeader').textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getDashboardData&staffName=${currentUser}&month=${month}&year=${year}`);
                if (!res.ok) throw new Error(`Server responded with status: ${res.status}`);
                const result = await res.json();
                if (result.error) throw new Error(result.error);
                renderCalendar(month, year, result.data || []);
            } catch (err) {
                console.error("Failed to fetch dashboard data:", err);
                alert(`Could not load dashboard data: ${err.message}`);
                renderCalendar(month, year, []); // Render empty on error
            }
        }
        
        function renderCalendar(month, year, data) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="calendar-day bg-gray-50"></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = data.find(d => {
                    // **FIXED:** Parse date string as UTC to avoid timezone shifts.
                    const dateParts = d.Date.split('-'); // e.g., "2025-10-20"
                    const dataDate = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));
                    return dataDate.getUTCFullYear() === year && dataDate.getUTCMonth() === month && dataDate.getUTCDate() === day;
                });
                grid.innerHTML += `
                    <div class="calendar-day p-2">
                        <div class="font-bold text-sm">${day}</div>
                        <div class="mt-1 space-y-1">
                            <div><span class="metric-label">Dials:</span> <span class="metric-value">${dayData?.Dials || '-'}</span></div>
                            <div><span class="metric-label">Pres:</span> <span class="metric-value">${dayData?.Presentations || '-'}</span></div>
                            <div><span class="metric-label">Binds:</span> <span class="metric-value">${dayData?.Binds || '-'}</span></div>
                            <div><span class="metric-label">ALP:</span> <span class="metric-value">${dayData?.ALP || '-'}</span></div>
                        </div>
                    </div>
                `;
            }
        }
        
        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderDashboard();
        }

        // --- Data Submission ---
        async function submitClockIn() {
            const data = {
                staffName: currentUser,
                date: new Date().toISOString(),
                time: new Date().toLocaleTimeString(),
                type: 'ClockIn',
                metrics: {
                    dials: document.getElementById('yesterdayDials').value,
                    presentations: document.getElementById('yesterdayPresentations').value,
                    binds: document.getElementById('yesterdayBinds').value,
                    alp: document.getElementById('yesterdayAlp').value,
                }
            };
            await submitData('logClockEvent', data, 'clockInModal');
        }

        async function submitClockOut() {
            const data = {
                staffName: currentUser,
                date: new Date().toISOString(),
                time: new Date().toLocaleTimeString(),
                type: 'ClockOut',
                metrics: {
                    dials: document.getElementById('todayDials').value,
                    presentations: document.getElementById('todayPresentations').value,
                    binds: document.getElementById('todayBinds').value,
                    alp: document.getElementById('todayAlp').value,
                }
            };
            await submitData('logClockEvent', data, 'clockOutModal');
        }
        
        async function submitActivity() {
             const data = {
                staffName: currentUser,
                date: new Date().toLocaleDateString(),
                activityType: document.getElementById('activityType').value,
                outcome: document.getElementById('activityOutcome').value,
                customerInfo: document.getElementById('activityCustomer').value,
                alp: document.getElementById('activityAlp').value,
                notes: document.getElementById('activityNotes').value,
            };
            await submitData('logActivity', data, 'logActivityModal');
        }
        
        async function submitData(action, data, modalId) {
             if (!SCRIPT_URL) return alert('SCRIPT_URL is not configured.');
             try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, data })
                });

                // **FIXED:** Check if the server responded successfully.
                if (!response.ok) {
                    // Try to get a more specific error message from the backend.
                    const errorText = await response.text();
                    throw new Error(`Server error (${response.status}): ${errorText}`);
                }

                const result = await response.json();

                // **FIXED:** Check for application-level errors returned by the script.
                if (result.error) {
                    throw new Error(result.error);
                }
                
                alert('Data submitted successfully!');
                closeModal(modalId);
                renderDashboard();
             } catch (err) {
                console.error(`Failed to submit ${action}:`, err);
                alert(`Error submitting data: ${err.message}`);
             }
        }
    </script>
</body>
</html>

